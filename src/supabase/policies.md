
-- ================================================================================================
-- EduSync SaaS Platform - Definitive Multi-Tenant Schema & RLS Policy v4.2
-- Description: This script refactors the database for multi-tenancy. It introduces a `schools`
--              table and adds a `school_id` to all relevant tables to isolate data. This version
--              adds the concept of a `super_admin` and a `domain` column for custom domains.
--
-- INSTRUCTIONS: Run this entire script in your Supabase SQL Editor. THIS IS A MAJOR CHANGE.
--               After running, you will need to manually create your first school in the `schools`
--               table and get its UUID to configure your first admin user.
-- ================================================================================================

-- ================================================================================================
-- Section 1: Create the new `schools` table
-- This table will hold information for each school client.
-- ================================================================================================
CREATE TABLE IF NOT EXISTS public.schools (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  domain TEXT UNIQUE, -- New column for custom domain
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);
COMMENT ON TABLE public.schools IS 'Stores information about each school (tenant) in the platform.';
COMMENT ON COLUMN public.schools.domain IS 'The custom domain associated with the school (e.g., portal.sjm.com)';


-- ================================================================================================
-- Section 2: Add `school_id` to all necessary tables and apply foreign key constraints.
-- ================================================================================================

-- Add school_id to app_settings
-- We need a single primary key. 'id' is better if we might have non-school-specific settings later.
-- Let's revert to a simple `id` as PK and keep `school_id` as a nullable, unique foreign key.
ALTER TABLE public.app_settings DROP CONSTRAINT IF EXISTS app_settings_pkey;
ALTER TABLE public.app_settings ADD COLUMN IF NOT EXISTS id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY;
ALTER TABLE public.app_settings ADD COLUMN IF NOT EXISTS school_id UUID UNIQUE REFERENCES public.schools(id) ON DELETE CASCADE;
COMMENT ON COLUMN public.app_settings.school_id IS 'Uniquely identifies the school these settings belong to.';

-- Add school_id to user_roles and update primary key
ALTER TABLE public.user_roles ADD COLUMN IF NOT EXISTS school_id UUID REFERENCES public.schools(id) ON DELETE CASCADE;
ALTER TABLE public.user_roles DROP CONSTRAINT IF EXISTS user_roles_pkey;
ALTER TABLE public.user_roles ADD PRIMARY KEY (user_id); -- user_id should be unique across all schools

-- Add school_id to students
ALTER TABLE public.students ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to teachers
ALTER TABLE public.teachers ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to school_announcements
ALTER TABLE public.school_announcements ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to school_fee_items
ALTER TABLE public.school_fee_items ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to fee_payments
ALTER TABLE public.fee_payments ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to student_arrears
ALTER TABLE public.student_arrears ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to academic_results
ALTER TABLE public.academic_results ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to attendance_records
ALTER TABLE public.attendance_records ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to behavior_incidents
ALTER TABLE public.behavior_incidents ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to assignments
ALTER TABLE public.assignments ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;

-- Add school_id to timetable_entries
ALTER TABLE public.timetable_entries ADD COLUMN IF NOT EXISTS school_id UUID NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE;


-- ================================================================================================
-- Section 3: Helper Functions for Multi-Tenancy
-- These functions will help RLS policies identify the user's role and school.
-- ================================================================================================

-- Returns the school_id of the currently authenticated user.
CREATE OR REPLACE FUNCTION get_my_school_id()
RETURNS uuid AS $$
  SELECT school_id
  FROM public.user_roles
  WHERE user_id = auth.uid()
  LIMIT 1;
$$ LANGUAGE sql SECURITY DEFINER SET search_path = '';

-- Checks if the user is a super_admin.
CREATE OR REPLACE FUNCTION is_super_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = auth.uid() AND role = 'super_admin'
  );
$$ LANGUAGE sql SECURITY DEFINER SET search_path = '';

-- Checks if the user is an admin of their associated school.
CREATE OR REPLACE FUNCTION is_school_admin()
RETURNS boolean AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = auth.uid() AND role = 'admin' AND school_id IS NOT NULL
  );
$$ LANGUAGE sql SECURITY DEFINER SET search_path = '';

-- ================================================================================================
-- Section 4: All RLS Policies for a Multi-Tenant Architecture
-- ================================================================================================

-- --- Table: schools ---
-- Only super_admins can manage schools.
ALTER TABLE public.schools ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Allow service_role full access" ON public.schools;
DROP POLICY IF EXISTS "Super admins can manage schools" ON public.schools;
DROP POLICY IF EXISTS "Public can read schools" ON public.schools;
CREATE POLICY "Super admins can manage schools" ON public.schools FOR ALL USING (is_super_admin()) WITH CHECK (is_super_admin());
CREATE POLICY "Public can read schools" ON public.schools FOR SELECT USING (true);


-- --- Table: app_settings ---
ALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Enable public read access based on school_id" ON public.app_settings;
DROP POLICY IF EXISTS "Admins can manage their own school settings" ON public.app_settings;
-- Allows ANYONE to READ settings. The app must provide the school_id.
CREATE POLICY "Enable public read access based on school_id" ON public.app_settings FOR SELECT USING (true);
-- School admins can manage settings for THEIR OWN school. Super admins can manage ANY school's settings.
CREATE POLICY "Admins can manage school settings" ON public.app_settings FOR ALL
USING (is_super_admin() OR (school_id = get_my_school_id() AND is_school_admin()))
WITH CHECK (is_super_admin() OR (school_id = get_my_school_id() AND is_school_admin()));


-- --- Table: user_roles ---
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Users can view their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Admins can manage roles within their school" ON public.user_roles;
DROP POLICY IF EXISTS "Super Admins can manage all roles" ON public.user_roles;
-- A user can see their own role information.
CREATE POLICY "Users can view their own role" ON public.user_roles FOR SELECT TO authenticated USING (auth.uid() = user_id);
-- School admins can manage roles ONLY for users within their own school. Super admins have full access.
CREATE POLICY "Admins can manage roles" ON public.user_roles FOR ALL
USING (is_super_admin() OR (school_id = get_my_school_id() AND is_school_admin()))
WITH CHECK (is_super_admin() OR (school_id = get_my_school_id() AND is_school_admin()));


-- --- Table: students ---
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access students in their school" ON public.students;
-- A user can only access/manage students that belong to their own school. Super admins can access all.
CREATE POLICY "School members can access students in their school" ON public.students FOR ALL
USING (is_super_admin() OR school_id = get_my_school_id())
WITH CHECK (is_super_admin() OR school_id = get_my_school_id());


-- --- Table: teachers ---
ALTER TABLE public.teachers ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access teachers in their school" ON public.teachers;
-- A user can only access/manage teachers that belong to their own school. Super admins can access all.
CREATE POLICY "School members can access teachers in their school" ON public.teachers FOR ALL
USING (is_super_admin() OR school_id = get_my_school_id())
WITH CHECK (is_super_admin() OR school_id = get_my_school_id());


-- All other tables follow the same pattern:
-- You can only access/manage data that has a `school_id` matching your own, or if you're a super_admin.

-- --- Table: school_announcements ---
ALTER TABLE public.school_announcements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access announcements in their school" ON public.school_announcements;
CREATE POLICY "School members can access announcements in their school" ON public.school_announcements FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: school_fee_items ---
ALTER TABLE public.school_fee_items ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access fee items in their school" ON public.school_fee_items;
CREATE POLICY "School members can access fee items in their school" ON public.school_fee_items FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: fee_payments ---
ALTER TABLE public.fee_payments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access payments in their school" ON public.fee_payments;
DROP POLICY IF EXISTS "Service role can create payments" ON public.fee_payments;
CREATE POLICY "School members can access payments in their school" ON public.fee_payments FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());
CREATE POLICY "Service role can create payments" ON public.fee_payments FOR INSERT TO service_role WITH CHECK (true); -- For webhooks

-- --- Table: student_arrears ---
ALTER TABLE public.student_arrears ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access arrears in their school" ON public.student_arrears;
CREATE POLICY "School members can access arrears in their school" ON public.student_arrears FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: academic_results ---
ALTER TABLE public.academic_results ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access results in their school" ON public.academic_results;
DROP POLICY IF EXISTS "Students can view their own approved results" ON public.academic_results;
CREATE POLICY "School members can access results in their school" ON public.academic_results FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());
CREATE POLICY "Students can view their own approved results" ON public.academic_results FOR SELECT USING (school_id = get_my_school_id() AND student_id_display = (SELECT student_id_display FROM public.students s WHERE s.auth_user_id = auth.uid()) AND approval_status = 'approved' AND published_at IS NOT NULL AND published_at <= now());

-- --- Table: attendance_records ---
ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access attendance in their school" ON public.attendance_records;
CREATE POLICY "School members can access attendance in their school" ON public.attendance_records FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: behavior_incidents ---
ALTER TABLE public.behavior_incidents ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access incidents in their school" ON public.behavior_incidents;
CREATE POLICY "School members can access incidents in their school" ON public.behavior_incidents FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: assignments ---
ALTER TABLE public.assignments ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access assignments in their school" ON public.assignments;
CREATE POLICY "School members can access assignments in their school" ON public.assignments FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());

-- --- Table: timetable_entries ---
ALTER TABLE public.timetable_entries ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "School members can access timetables in their school" ON public.timetable_entries;
CREATE POLICY "School members can access timetables in their school" ON public.timetable_entries FOR ALL USING (is_super_admin() OR school_id = get_my_school_id()) WITH CHECK (is_super_admin() OR school_id = get_my_school_id());


-- ================================================================================================
-- Section 5: Storage Policies
-- ================================================================================================

-- Policies for 'school-assets' bucket (logos, hero images, etc.)
DROP POLICY IF EXISTS "Public can read school assets" ON storage.objects;
DROP POLICY IF EXISTS "Admins can manage school assets" ON storage.objects;
CREATE POLICY "Public can read school assets" ON storage.objects FOR SELECT USING (bucket_id = 'school-assets');
CREATE POLICY "Admins can manage school assets" ON storage.objects FOR ALL USING (bucket_id = 'school-assets' AND (is_school_admin() OR is_super_admin())) WITH CHECK (bucket_id = 'school-assets' AND (is_school_admin() OR is_super_admin()));

-- Policies for 'assignment-files' bucket
DROP POLICY IF EXISTS "Public read access for assignment files" ON storage.objects;
DROP POLICY IF EXISTS "Admins can manage assignment files" ON storage.objects;
DROP POLICY IF EXISTS "Teachers can manage their own assignment files" ON storage.objects;
CREATE POLICY "Public read access for assignment files" ON storage.objects FOR SELECT USING (bucket_id = 'assignment-files');
CREATE POLICY "Admins can manage assignment files" ON storage.objects FOR ALL USING (bucket_id = 'assignment-files' AND (is_school_admin() OR is_super_admin())) WITH CHECK (bucket_id = 'assignment-files' AND (is_school_admin() OR is_super_admin()));
CREATE POLICY "Teachers can manage their own assignment files" ON storage.objects FOR ALL USING (bucket_id = 'assignment-files' AND owner = auth.uid()) WITH CHECK (bucket_id = 'assignment-files' AND owner = auth.uid());


-- ========================== END OF SCRIPT ==========================
