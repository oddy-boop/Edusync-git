-- ==================================================================
-- EduSync Platform - Complete Database Schema
-- Version: 11.0 - Super Admin & RLS Definitive Fix
-- Description: Corrects the user_roles table to allow NULL school_id
-- for super_admins and updates RLS policies to handle this case,
-- ensuring super_admins have true platform-wide access.
-- ==================================================================

-- Drop existing functions and tables in reverse order of dependency
DROP FUNCTION IF EXISTS public.get_my_role();
DROP TABLE IF EXISTS public.audit_logs;
DROP TABLE IF EXISTS public.expenditures;
DROP TABLE IF EXISTS public.staff_attendance;
DROP TABLE IF EXISTS public.admission_applications;
DROP TABLE IF EXISTS public.news_posts;
DROP TABLE IF EXISTS public.timetable_entries;
DROP TABLE IF EXISTS public.assignments;
DROP TABLE IF EXISTS public.behavior_incidents;
DROP TABLE IF EXISTS public.attendance_records;
DROP TABLE IF EXISTS public.academic_results;
DROP TABLE IF EXISTS public.student_arrears;
DROP TABLE IF EXISTS public.fee_payments;
DROP TABLE IF EXISTS public.school_fee_items;
DROP TABLE IF EXISTS public.school_announcements;
DROP TABLE IF EXISTS public.students;
DROP TABLE IF EXISTS public.teachers;
DROP TABLE IF EXISTS public.user_roles;
DROP TABLE IF EXISTS public.schools;


-- ==================================================================
-- Section 1: Core Multi-Tenant and Profile Tables
-- ==================================================================

CREATE TABLE public.schools (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name character varying(255) NOT NULL,
    domain character varying(100) UNIQUE,
    address text,
    phone character varying(50),
    email character varying(255),
    logo_url text,
    current_academic_year character varying(20) DEFAULT '2023-2024',
    paystack_public_key text,
    paystack_secret_key text,
    resend_api_key text,
    google_api_key text,
    twilio_account_sid text,
    twilio_auth_token text,
    twilio_phone_number text,
    twilio_messaging_service_sid text,
    enable_email_notifications boolean DEFAULT true,
    enable_sms_notifications boolean DEFAULT true,
    email_footer_signature text,
    school_latitude double precision,
    school_longitude double precision,
    check_in_radius_meters integer,
    facebook_url text,
    twitter_url text,
    instagram_url text,
    linkedin_url text,
    homepage_title text,
    homepage_subtitle text,
    hero_image_url_1 text,
    hero_image_url_2 text,
    hero_image_url_3 text,
    hero_image_url_4 text,
    hero_image_url_5 text,
    homepage_welcome_title text,
    homepage_welcome_message text,
    homepage_welcome_image_url text,
    homepage_why_us_title text,
    homepage_why_us_points jsonb,
    homepage_news_title text,
    about_mission text,
    about_vision text,
    about_image_url text,
    admissions_intro text,
    admissions_pdf_url text,
    admissions_steps jsonb,
    programs_intro text,
    team_members jsonb,
    program_creche_image_url text,
    program_kindergarten_image_url text,
    program_primary_image_url text,
    program_jhs_image_url text,
    donate_image_url text,
    color_primary text,
    color_accent text,
    color_background text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

CREATE TABLE public.user_roles (
    user_id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    school_id bigint REFERENCES public.schools(id) ON DELETE CASCADE,
    role character varying(50) NOT NULL,
    CONSTRAINT school_id_not_null_for_non_super_admins CHECK (
      (role = 'super_admin' AND school_id IS NULL) OR
      (role <> 'super_admin' AND school_id IS NOT NULL)
    )
);

CREATE TABLE public.teachers (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    auth_user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    full_name character varying(255) NOT NULL,
    email character varying(255) UNIQUE NOT NULL,
    date_of_birth date,
    location text,
    contact_number character varying(50),
    subjects_taught text[],
    assigned_classes text[],
    is_deleted boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

CREATE TABLE public.students (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    auth_user_id uuid UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    student_id_display character varying(20) NOT NULL,
    full_name character varying(255) NOT NULL,
    date_of_birth date,
    grade_level character varying(50),
    guardian_name text,
    guardian_contact character varying(50),
    contact_email character varying(255),
    total_paid_override numeric(10, 2),
    notification_preferences jsonb,
    is_deleted boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone,
    CONSTRAINT unique_student_id_per_school UNIQUE (school_id, student_id_display)
);

CREATE TABLE public.admission_applications (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    full_name text NOT NULL,
    date_of_birth date NOT NULL,
    student_religion text,
    student_location text,
    grade_level_applying_for text NOT NULL,
    previous_school_name text,
    father_name text,
    mother_name text,
    guardian_contact text NOT NULL,
    guardian_email text NOT NULL,
    guardian_religion text,
    guardian_location text,
    status text NOT NULL DEFAULT 'pending',
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- ==================================================================
-- Section 2: General School Operations Tables (Multi-Tenant)
-- ==================================================================

CREATE TABLE public.school_announcements (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    author_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    author_name text,
    title text NOT NULL,
    message text NOT NULL,
    target_audience character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

CREATE TABLE public.news_posts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    author_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    author_name text,
    title text NOT NULL,
    content text,
    image_url text,
    published_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

CREATE TABLE public.timetable_entries (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE CASCADE,
    day_of_week text NOT NULL,
    periods jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

CREATE TABLE public.assignments (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE CASCADE,
    teacher_name text,
    class_id character varying(50) NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    due_date date NOT NULL,
    file_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- ==================================================================
-- Section 3: Financial Tables (Multi-Tenant)
-- ==================================================================

CREATE TABLE public.school_fee_items (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    grade_level text NOT NULL,
    term text NOT NULL,
    description text NOT NULL,
    amount numeric(10, 2) NOT NULL,
    academic_year character varying(20) NOT NULL
);

CREATE TABLE public.fee_payments (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    payment_id_display text UNIQUE NOT NULL,
    student_id_display text NOT NULL,
    student_name text,
    grade_level text,
    amount_paid numeric(10, 2) NOT NULL,
    payment_date date NOT NULL,
    payment_method text NOT NULL,
    term_paid_for text,
    notes text,
    received_by_name text,
    received_by_user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL
);

CREATE TABLE public.student_arrears (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    student_id_display text NOT NULL,
    student_name text,
    grade_level_at_arrear text,
    academic_year_from text NOT NULL,
    academic_year_to text NOT NULL,
    amount numeric(10, 2) NOT NULL,
    status text NOT NULL,
    notes text,
    created_by_user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL
);

CREATE TABLE public.expenditures (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    amount numeric(12, 2) NOT NULL,
    category text NOT NULL,
    date date NOT NULL,
    description text
);

-- ==================================================================
-- Section 4: Academic & Behavioral Tracking Tables (Multi-Tenant)
-- ==================================================================

CREATE TABLE public.academic_results (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    auth_user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE SET NULL,
    teacher_name text,
    student_id_display text NOT NULL,
    student_name text,
    class_id text,
    term text,
    year text,
    subject_results jsonb,
    overall_average text,
    overall_grade text,
    overall_remarks text,
    published_at timestamp with time zone,
    requested_published_at timestamp with time zone,
    approval_status text,
    admin_remarks text,
    approved_by_admin_auth_id uuid,
    approval_timestamp timestamp with time zone,
    attendance_summary jsonb
);

CREATE TABLE public.attendance_records (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    student_id_display text NOT NULL,
    student_name text,
    class_id text NOT NULL,
    date date NOT NULL,
    status text NOT NULL,
    notes text,
    marked_by_teacher_auth_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    marked_by_teacher_name text,
    CONSTRAINT unique_attendance_per_day_per_school UNIQUE (school_id, student_id_display, date)
);

CREATE TABLE public.staff_attendance (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    teacher_id uuid NOT NULL REFERENCES public.teachers(id) ON DELETE CASCADE,
    date date NOT NULL,
    status text NOT NULL,
    notes text,
    marked_by_admin_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    CONSTRAINT unique_staff_attendance_per_day_per_school UNIQUE (school_id, teacher_id, date)
);

CREATE TABLE public.behavior_incidents (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    student_id_display text NOT NULL,
    student_name text,
    class_id text,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE SET NULL,
    teacher_name text,
    type text,
    description text,
    date date,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

CREATE TABLE public.audit_logs (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    school_id bigint NOT NULL REFERENCES public.schools(id) ON DELETE CASCADE,
    action text NOT NULL,
    performed_by uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    target_id text,
    details jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- ==================================================================
-- Section 5: Row Level Security (RLS) Policies
-- ==================================================================

-- Enable RLS for all tables
ALTER TABLE public.schools ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.teachers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admission_applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.school_announcements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.news_posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.timetable_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.school_fee_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fee_payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.student_arrears ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.expenditures ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.academic_results ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.staff_attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.behavior_incidents ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;

-- Helper function to get the role of the currently authenticated user.
-- SECURITY DEFINER allows it to bypass RLS on user_roles to check the role.
CREATE OR REPLACE FUNCTION get_my_role()
RETURNS text
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  user_role text;
BEGIN
  SELECT role INTO user_role
  FROM public.user_roles
  WHERE user_id = auth.uid();
  RETURN user_role;
END;
$$;

-- Helper function to get the school_id of the currently authenticated user.
CREATE OR REPLACE FUNCTION get_my_school_id()
RETURNS bigint
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  user_school_id bigint;
BEGIN
  SELECT school_id INTO user_school_id
  FROM public.user_roles
  WHERE user_id = auth.uid();
  RETURN user_school_id;
END;
$$;

-- ** Core Policies **

-- user_roles: Anyone can see their own role. Super admins see all.
DROP POLICY IF EXISTS "Allow user to see their own role" ON public.user_roles;
DROP POLICY IF EXISTS "Enable all access for super_admins" ON public.user_roles;
CREATE POLICY "Allow user to see their own role" ON public.user_roles FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Enable all access for super_admins" ON public.user_roles FOR ALL USING (get_my_role() = 'super_admin');

-- schools: Publicly readable, but only super admins can modify.
DROP POLICY IF EXISTS "Schools are publicly viewable" ON public.schools;
DROP POLICY IF EXISTS "Super admins can manage schools" ON public.schools;
CREATE POLICY "Schools are publicly viewable" ON public.schools FOR SELECT USING (true);
CREATE POLICY "Super admins can manage schools" ON public.schools FOR ALL USING (get_my_role() = 'super_admin');


-- ** Policies for School-Scoped Data (Multi-Tenant) **

-- This policy grants branch admins full access to data related to their own school.
CREATE OR REPLACE FUNCTION is_my_school_record(record_school_id bigint)
RETURNS boolean
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN get_my_role() = 'super_admin' OR (
    (get_my_role() = 'admin' OR get_my_role() = 'accountant') AND
    get_my_school_id() = record_school_id
  );
END;
$$;

-- Apply the generic admin policy to all relevant tables.
CREATE POLICY "Admins can manage their school's data" ON public.teachers FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.students FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.admission_applications FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.school_announcements FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.news_posts FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.timetable_entries FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.assignments FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.school_fee_items FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.fee_payments FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.student_arrears FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.expenditures FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.academic_results FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.attendance_records FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.staff_attendance FOR ALL USING (is_my_school_record(school_id));
CREATE POLICY "Admins can manage their school's data" ON public.behavior_incidents FOR ALL USING (is_my_school_record(school_id));


-- ** Teacher-specific policies **
CREATE POLICY "Teachers can view their own profile" ON public.teachers FOR SELECT USING (auth_user_id = auth.uid());
CREATE POLICY "Teachers can update their own profile" ON public.teachers FOR UPDATE USING (auth_user_id = auth.uid()) WITH CHECK (auth_user_id = auth.uid());
CREATE POLICY "Teachers can view students in their assigned classes" ON public.students FOR SELECT USING (grade_level = ANY (ARRAY(SELECT unnest(assigned_classes) FROM public.teachers WHERE auth_user_id = auth.uid())));
CREATE POLICY "Teachers can manage their own timetable" ON public.timetable_entries FOR ALL USING (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id) WITH CHECK (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id);
CREATE POLICY "Teachers can manage their own assignments" ON public.assignments FOR ALL USING (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id) WITH CHECK (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id);
CREATE POLICY "Teachers can manage their own behavior logs" ON public.behavior_incidents FOR ALL USING (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id) WITH CHECK (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()));
CREATE POLICY "Teachers can manage attendance for their assigned classes" ON public.attendance_records FOR ALL USING (class_id = ANY (ARRAY(SELECT unnest(assigned_classes) FROM public.teachers WHERE auth_user_id = auth.uid()))) WITH CHECK (class_id = ANY (ARRAY(SELECT unnest(assigned_classes) FROM public.teachers WHERE auth_user_id = auth.uid())));
CREATE POLICY "Teachers can manage academic results for students in their assigned classes" ON public.academic_results FOR ALL USING (class_id = ANY (ARRAY(SELECT unnest(assigned_classes) FROM public.teachers WHERE auth_user_id = auth.uid()))) WITH CHECK (class_id = ANY (ARRAY(SELECT unnest(assigned_classes) FROM public.teachers WHERE auth_user_id = auth.uid())));
CREATE POLICY "Teachers can view their own attendance" ON public.staff_attendance FOR SELECT USING (( SELECT teachers.id FROM public.teachers WHERE auth_user_id = auth.uid()) = teacher_id);

-- ** Student-specific policies **
CREATE POLICY "Students can view their own profile" ON public.students FOR SELECT USING (auth_user_id = auth.uid());
CREATE POLICY "Students can view their own results" ON public.academic_results FOR SELECT USING (auth_user_id = auth.uid());
CREATE POLICY "Students can view their own payments" ON public.fee_payments FOR SELECT USING (student_id_display = (SELECT students.student_id_display FROM public.students WHERE students.auth_user_id = auth.uid()));
CREATE POLICY "Students can view their own arrears" ON public.student_arrears FOR SELECT USING (student_id_display = (SELECT students.student_id_display FROM public.students WHERE students.auth_user_id = auth.uid()));
CREATE POLICY "Students can view their own attendance" ON public.attendance_records FOR SELECT USING (student_id_display = (SELECT students.student_id_display FROM public.students WHERE students.auth_user_id = auth.uid()));
CREATE POLICY "Students can view announcements for their school" ON public.school_announcements FOR SELECT USING (target_audience = 'All' OR target_audience = 'Students');
CREATE POLICY "Students can view assignments for their class" ON public.assignments FOR SELECT USING (class_id = (SELECT grade_level FROM public.students WHERE auth_user_id = auth.uid()));

-- ** Public access for news posts **
CREATE POLICY "News posts are public" ON public.news_posts FOR SELECT USING (true);


-- ==================================================================
-- Section 6: Storage Policies
-- ==================================================================

-- Bucket: school-assets (public images like logos)
DROP POLICY IF EXISTS "Public read access for school assets" ON storage.objects;
CREATE POLICY "Public read access for school assets" ON storage.objects FOR SELECT USING (bucket_id = 'school-assets');
DROP POLICY IF EXISTS "Admins can upload school assets" ON storage.objects;
CREATE POLICY "Admins can upload school assets" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'school-assets' AND (get_my_role() = 'admin' OR get_my_role() = 'super_admin'));

-- Bucket: assignment-files (restricted files)
DROP POLICY IF EXISTS "Allow teachers to manage their own assignment files" ON storage.objects;
CREATE POLICY "Allow teachers to manage their own assignment files" ON storage.objects FOR ALL
USING (bucket_id = 'assignment-files' AND owner = auth.uid())
WITH CHECK (bucket_id = 'assignment-files' AND owner = auth.uid());

DROP POLICY IF EXISTS "Allow admin full access to assignment files" ON storage.objects;
CREATE POLICY "Allow admin full access to assignment files" ON storage.objects FOR ALL
USING (bucket_id = 'assignment-files' AND (get_my_role() = 'admin' OR get_my_role() = 'super_admin'));

DROP POLICY IF EXISTS "Allow students to read assignment files for their class" ON storage.objects;
CREATE POLICY "Allow students to read assignment files for their class" ON storage.objects FOR SELECT USING (
  bucket_id = 'assignment-files' AND
  (EXISTS (
    SELECT 1 FROM public.assignments a
    JOIN public.students s ON a.class_id = s.grade_level
    WHERE s.auth_user_id = auth.uid()
    AND a.file_url LIKE '%' || storage.objects.name
  ))
);
