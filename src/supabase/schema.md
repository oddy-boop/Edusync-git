-- ==================================================================
-- EduSync Platform - Complete Database Schema
-- Version: 5.6
-- Description: Adds admission_applications table for online submissions.
-- ==================================================================

-- Drop tables in reverse order of dependency to avoid errors
DROP TABLE IF EXISTS public.audit_logs;
DROP TABLE IF EXISTS public.staff_attendance;
DROP TABLE IF EXISTS public.admission_applications; -- New
DROP TABLE IF EXISTS public.news_posts;
DROP TABLE IF EXISTS public.timetable_entries;
DROP TABLE IF EXISTS public.assignments;
DROP TABLE IF EXISTS public.behavior_incidents;
DROP TABLE IF EXISTS public.attendance_records;
DROP TABLE IF EXISTS public.academic_results;
DROP TABLE IF EXISTS public.student_arrears;
DROP TABLE IF EXISTS public.fee_payments;
DROP TABLE IF EXISTS public.school_fee_items;
DROP TABLE IF EXISTS public.school_announcements;
DROP TABLE IF EXISTS public.students;
DROP TABLE IF EXISTS public.teachers;
DROP TABLE IF EXISTS public.user_roles;
DROP TABLE IF EXISTS public.app_settings;


-- ==================================================================
-- Section 1: Core User and School Management Tables
-- ==================================================================

-- Table: app_settings
-- Stores global settings for the school instance. A single row app.
CREATE TABLE public.app_settings (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    current_academic_year character varying(20) NOT NULL DEFAULT '2023-2024',
    school_name character varying(255) NOT NULL DEFAULT 'EduSync School',
    school_address text,
    school_phone character varying(50),
    school_email character varying(255),
    school_logo_url text,
    facebook_url text,
    twitter_url text,
    instagram_url text,
    linkedin_url text,
    enable_email_notifications boolean DEFAULT true,
    enable_sms_notifications boolean DEFAULT true,
    email_footer_signature text,
    paystack_public_key text,
    paystack_secret_key text,
    resend_api_key text,
    google_api_key text,
    -- Homepage Content
    homepage_title text,
    homepage_subtitle text,
    hero_image_url_1 text,
    hero_image_url_2 text,
    hero_image_url_3 text,
    hero_image_url_4 text,
    hero_image_url_5 text,
    homepage_welcome_title text,
    homepage_welcome_message text,
    homepage_welcome_image_url text,
    homepage_why_us_title text,
    homepage_why_us_points jsonb,
    homepage_news_title text,
    -- About Page Content
    about_mission text,
    about_vision text,
    about_image_url text,
    team_members jsonb,
    -- Admissions Page Content
    admissions_intro text,
    admissions_pdf_url text,
    admissions_steps jsonb,
    -- Programs Page Content
    programs_intro text,
    program_creche_image_url text,
    program_kindergarten_image_url text,
    program_primary_image_url text,
    program_jhs_image_url text,
    -- Donate Page Content
    donate_image_url text,
    -- Theme/Branding
    color_primary text,
    color_accent text,
    color_background text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Ensure there is only one row for settings.
-- You can manually insert the first row: INSERT INTO public.app_settings (id) VALUES (1);
ALTER TABLE public.app_settings ADD CONSTRAINT app_settings_singleton CHECK (id = 1);


-- Table: user_roles
-- Links authenticated users to their roles.
CREATE TABLE public.user_roles (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    role character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Table: teachers
-- Stores teacher profile information.
CREATE TABLE public.teachers (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    auth_user_id uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
    full_name character varying(255) NOT NULL,
    email character varying(255) UNIQUE NOT NULL,
    date_of_birth date,
    contact_number character varying(50),
    subjects_taught text[],
    assigned_classes text[],
    school_id bigint REFERENCES public.app_settings(id) ON DELETE SET NULL,
    is_deleted boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Table: students
-- Stores student profile information.
CREATE TABLE public.students (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    auth_user_id uuid UNIQUE REFERENCES auth.users(id) ON DELETE SET NULL,
    student_id_display character varying(20) UNIQUE NOT NULL,
    full_name character varying(255) NOT NULL,
    date_of_birth date,
    grade_level character varying(50),
    guardian_name character varying(255),
    guardian_contact character varying(50),
    contact_email character varying(255),
    total_paid_override numeric(10, 2),
    notification_preferences jsonb,
    is_deleted boolean DEFAULT false NOT NULL,
    school_id bigint REFERENCES public.app_settings(id) ON DELETE SET NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Table: admission_applications (NEW)
-- Stores online admission applications from prospective students.
CREATE TABLE public.admission_applications (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    full_name text NOT NULL,
    date_of_birth date NOT NULL,
    student_religion text,
    student_location text,
    grade_level_applying_for text NOT NULL,
    previous_school_name text,
    guardian_name text NOT NULL,
    guardian_contact text NOT NULL,
    guardian_email text NOT NULL,
    guardian_religion text,
    guardian_location text,
    status text NOT NULL DEFAULT 'pending', -- pending, accepted, rejected, waitlisted
    notes text, -- Admin notes
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


-- ==================================================================
-- Section 2: General School Operations Tables
-- ==================================================================

-- Table: school_announcements (For internal announcements)
CREATE TABLE public.school_announcements (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    author_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    author_name text,
    title text NOT NULL,
    message text NOT NULL,
    target_audience character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- Table: news_posts (For public website news)
CREATE TABLE public.news_posts (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    author_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    author_name text,
    title text NOT NULL,
    content text,
    image_url text,
    published_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- Table: timetable_entries
CREATE TABLE public.timetable_entries (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE CASCADE,
    day_of_week text NOT NULL,
    periods jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- Table: assignments
CREATE TABLE public.assignments (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE CASCADE,
    teacher_name text,
    class_id character varying(50) NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    due_date date NOT NULL,
    file_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- ==================================================================
-- Section 3: Financial Tables
-- ==================================================================

-- Table: school_fee_items
CREATE TABLE public.school_fee_items (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    grade_level text NOT NULL,
    term text NOT NULL,
    description text NOT NULL,
    amount numeric(10, 2) NOT NULL,
    academic_year character varying(20) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- Table: fee_payments
CREATE TABLE public.fee_payments (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    payment_id_display text UNIQUE NOT NULL,
    student_id_display text NOT NULL,
    student_name text,
    grade_level text,
    amount_paid numeric(10, 2) NOT NULL,
    payment_date date NOT NULL,
    payment_method text NOT NULL,
    term_paid_for text,
    notes text,
    received_by_name text,
    received_by_user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL
);

-- Table: student_arrears
CREATE TABLE public.student_arrears (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id_display text NOT NULL,
    student_name text,
    grade_level_at_arrear text,
    academic_year_from text NOT NULL,
    academic_year_to text NOT NULL,
    amount numeric(10, 2) NOT NULL,
    status text NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone,
    created_by_user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL
);

-- ==================================================================
-- Section 4: Academic & Behavioral Tracking Tables
-- ==================================================================

-- Table: academic_results
CREATE TABLE public.academic_results (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE SET NULL,
    teacher_name text,
    student_id_display text NOT NULL,
    student_name text,
    class_id text,
    term text,
    year text,
    subject_results jsonb,
    overall_average text,
    overall_grade text,
    overall_remarks text,
    published_at timestamp with time zone,
    requested_published_at timestamp with time zone,
    approval_status text,
    admin_remarks text,
    approved_by_admin_auth_id uuid,
    approval_timestamp timestamp with time zone,
    attendance_summary jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);

-- Table: attendance_records (for students)
CREATE TABLE public.attendance_records (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id_display text NOT NULL,
    student_name text,
    class_id text NOT NULL,
    date date NOT NULL,
    status text NOT NULL,
    notes text,
    marked_by_teacher_auth_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    marked_by_teacher_name text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone,
    CONSTRAINT unique_attendance_per_day UNIQUE (student_id_display, date)
);

-- Table: staff_attendance (for teachers)
CREATE TABLE public.staff_attendance (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    teacher_id uuid NOT NULL REFERENCES public.teachers(id) ON DELETE CASCADE,
    date date NOT NULL,
    status text NOT NULL, -- e.g., 'Present', 'Absent', 'On Leave'
    notes text,
    marked_by_admin_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT unique_staff_attendance_per_day UNIQUE (teacher_id, date)
);


-- Table: behavior_incidents
CREATE TABLE public.behavior_incidents (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    student_id_display text NOT NULL,
    student_name text,
    class_id text,
    teacher_id uuid REFERENCES public.teachers(id) ON DELETE SET NULL,
    teacher_name text,
    type text,
    description text,
    date date,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone
);

-- Table: audit_logs
-- For tracking significant actions.
CREATE TABLE public.audit_logs (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    action text NOT NULL,
    performed_by uuid REFERENCES auth.users(id) ON DELETE SET NULL,
    target_id text,
    details jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
